{"version":3,"names":["cov_gmjs4kpfh","actualCoverage","createDecorator","timeout","IRemoteAgentService","s","remoteConnectionLatencyMeasurer","maxSampleCount","sampleDelay","initial","maxInitialCount","average","maxAverageCount","highLatencyMultiple","highLatencyMinThreshold","highLatencyMaxThreshold","lastMeasurement","undefined","latency","f","measure","remoteAgentService","currentLatency","Infinity","i","rtt","getRoundTripTime","b","Math","min","push","length","shift","initialLatency","reduce","sum","value","current","high"],"sources":["/home/user/Desktop/MintMind/src/vs/workbench/services/remote/common/remoteAgentService.ts"],"sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { RemoteAgentConnectionContext, IRemoteAgentEnvironment } from '../../../../platform/remote/common/remoteAgentEnvironment.js';\nimport { IChannel, IServerChannel } from '../../../../base/parts/ipc/common/ipc.js';\nimport { IDiagnosticInfoOptions, IDiagnosticInfo } from '../../../../platform/diagnostics/common/diagnostics.js';\nimport { Event } from '../../../../base/common/event.js';\nimport { PersistentConnectionEvent } from '../../../../platform/remote/common/remoteAgentConnection.js';\nimport { ITelemetryData, TelemetryLevel } from '../../../../platform/telemetry/common/telemetry.js';\nimport { timeout } from '../../../../base/common/async.js';\n\nexport const IRemoteAgentService = createDecorator<IRemoteAgentService>('remoteAgentService');\n\nexport interface IRemoteAgentService {\n\treadonly _serviceBrand: undefined;\n\n\tgetConnection(): IRemoteAgentConnection | null;\n\t/**\n\t * Get the remote environment. In case of an error, returns `null`.\n\t */\n\tgetEnvironment(): Promise<IRemoteAgentEnvironment | null>;\n\t/**\n\t * Get the remote environment. Can return an error.\n\t */\n\tgetRawEnvironment(): Promise<IRemoteAgentEnvironment | null>;\n\t/**\n\t * Get exit information for a remote extension host.\n\t */\n\tgetExtensionHostExitInfo(reconnectionToken: string): Promise<IExtensionHostExitInfo | null>;\n\n\t/**\n\t * Gets the round trip time from the remote extension host. Note that this\n\t * may be delayed if the extension host is busy.\n\t */\n\tgetRoundTripTime(): Promise<number | undefined>;\n\n\t/**\n\t * Gracefully ends the current connection, if any.\n\t */\n\tendConnection(): Promise<void>;\n\n\tgetDiagnosticInfo(options: IDiagnosticInfoOptions): Promise<IDiagnosticInfo | undefined>;\n\tupdateTelemetryLevel(telemetryLevel: TelemetryLevel): Promise<void>;\n\tlogTelemetry(eventName: string, data?: ITelemetryData): Promise<void>;\n\tflushTelemetry(): Promise<void>;\n}\n\nexport interface IExtensionHostExitInfo {\n\tcode: number;\n\tsignal: string;\n}\n\nexport interface IRemoteAgentConnection {\n\treadonly remoteAuthority: string;\n\n\treadonly onReconnecting: Event<void>;\n\treadonly onDidStateChange: Event<PersistentConnectionEvent>;\n\n\tend(): Promise<void>;\n\tdispose(): void;\n\tgetChannel<T extends IChannel>(channelName: string): T;\n\twithChannel<T extends IChannel, R>(channelName: string, callback: (channel: T) => Promise<R>): Promise<R>;\n\tregisterChannel<T extends IServerChannel<RemoteAgentConnectionContext>>(channelName: string, channel: T): void;\n\tgetInitialConnectionTimeMs(): Promise<number>;\n}\n\nexport interface IRemoteConnectionLatencyMeasurement {\n\n\treadonly initial: number | undefined;\n\treadonly current: number;\n\treadonly average: number;\n\n\treadonly high: boolean;\n}\n\nexport const remoteConnectionLatencyMeasurer = new class {\n\n\treadonly maxSampleCount = 5;\n\treadonly sampleDelay = 2000;\n\n\treadonly initial: number[] = [];\n\treadonly maxInitialCount = 3;\n\n\treadonly average: number[] = [];\n\treadonly maxAverageCount = 100;\n\n\treadonly highLatencyMultiple = 2;\n\treadonly highLatencyMinThreshold = 500;\n\treadonly highLatencyMaxThreshold = 1500;\n\n\tlastMeasurement: IRemoteConnectionLatencyMeasurement | undefined = undefined;\n\tget latency() { return this.lastMeasurement; }\n\n\tasync measure(remoteAgentService: IRemoteAgentService): Promise<IRemoteConnectionLatencyMeasurement | undefined> {\n\t\tlet currentLatency = Infinity;\n\n\t\t// Measure up to samples count\n\t\tfor (let i = 0; i < this.maxSampleCount; i++) {\n\t\t\tconst rtt = await remoteAgentService.getRoundTripTime();\n\t\t\tif (rtt === undefined) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tcurrentLatency = Math.min(currentLatency, rtt / 2 /* we want just one way, not round trip time */);\n\t\t\tawait timeout(this.sampleDelay);\n\t\t}\n\n\t\t// Keep track of average latency\n\t\tthis.average.push(currentLatency);\n\t\tif (this.average.length > this.maxAverageCount) {\n\t\t\tthis.average.shift();\n\t\t}\n\n\t\t// Keep track of initial latency\n\t\tlet initialLatency: number | undefined = undefined;\n\t\tif (this.initial.length < this.maxInitialCount) {\n\t\t\tthis.initial.push(currentLatency);\n\t\t} else {\n\t\t\tinitialLatency = this.initial.reduce((sum, value) => sum + value, 0) / this.initial.length;\n\t\t}\n\n\t\t// Remember as last measurement\n\t\tthis.lastMeasurement = {\n\t\t\tinitial: initialLatency,\n\t\t\tcurrent: currentLatency,\n\t\t\taverage: this.average.reduce((sum, value) => sum + value, 0) / this.average.length,\n\t\t\thigh: (() => {\n\n\t\t\t\t// based on the initial, average and current latency, try to decide\n\t\t\t\t// if the connection has high latency\n\t\t\t\t// Some rules:\n\t\t\t\t// - we require the initial latency to be computed\n\t\t\t\t// - we only consider latency above highLatencyMinThreshold as potentially high\n\t\t\t\t// - we require the current latency to be above the average latency by a factor of highLatencyMultiple\n\t\t\t\t// - but not if the latency is actually above highLatencyMaxThreshold\n\n\t\t\t\tif (typeof initialLatency === 'undefined') {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (currentLatency > this.highLatencyMaxThreshold) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tif (currentLatency > this.highLatencyMinThreshold && currentLatency > initialLatency * this.highLatencyMultiple) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t})()\n\t\t};\n\n\t\treturn this.lastMeasurement;\n\t}\n};\n"],"mappings":"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","ignoreList":[]}