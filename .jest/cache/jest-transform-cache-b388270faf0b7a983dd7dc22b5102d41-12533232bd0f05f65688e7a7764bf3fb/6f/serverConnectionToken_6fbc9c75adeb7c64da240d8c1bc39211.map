{"version":3,"names":["cov_2df5gne5dd","actualCoverage","cookie","fs","path","generateUuid","connectionTokenCookieName","connectionTokenQueryName","Promises","connectionTokenRegex","s","NoneServerConnectionToken","type","validate","connectionToken","f","MandatoryServerConnectionToken","value","constructor","ServerConnectionTokenParseError","message","parseServerConnectionToken","args","defaultValue","withoutConnectionToken","connectionTokenFile","b","rawConnectionToken","readFileSync","toString","replace","e","test","determineServerConnectionToken","readOrGenerateConnectionToken","storageLocation","join","fileContents","promises","readFile","err","writeFile","mode","requestHasValidConnectionToken","req","parsedUrl","query","cookies","parse","headers"],"sources":["/home/user/Desktop/MintMind/src/vs/server/node/serverConnectionToken.ts"],"sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as cookie from 'cookie';\nimport * as fs from 'fs';\nimport * as http from 'http';\nimport * as url from 'url';\nimport * as path from '../../base/common/path.js';\nimport { generateUuid } from '../../base/common/uuid.js';\nimport { connectionTokenCookieName, connectionTokenQueryName } from '../../base/common/network.js';\nimport { ServerParsedArgs } from './serverEnvironmentService.js';\nimport { Promises } from '../../base/node/pfs.js';\n\nconst connectionTokenRegex = /^[0-9A-Za-z_-]+$/;\n\nexport const enum ServerConnectionTokenType {\n\tNone,\n\tOptional,// TODO: Remove this soon\n\tMandatory\n}\n\nexport class NoneServerConnectionToken {\n\tpublic readonly type = ServerConnectionTokenType.None;\n\n\tpublic validate(connectionToken: unknown): boolean {\n\t\treturn true;\n\t}\n}\n\nexport class MandatoryServerConnectionToken {\n\tpublic readonly type = ServerConnectionTokenType.Mandatory;\n\n\tconstructor(public readonly value: string) {\n\t}\n\n\tpublic validate(connectionToken: unknown): boolean {\n\t\treturn (connectionToken === this.value);\n\t}\n}\n\nexport type ServerConnectionToken = NoneServerConnectionToken | MandatoryServerConnectionToken;\n\nexport class ServerConnectionTokenParseError {\n\tconstructor(\n\t\tpublic readonly message: string\n\t) { }\n}\n\nexport async function parseServerConnectionToken(args: ServerParsedArgs, defaultValue: () => Promise<string>): Promise<ServerConnectionToken | ServerConnectionTokenParseError> {\n\tconst withoutConnectionToken = args['without-connection-token'];\n\tconst connectionToken = args['connection-token'];\n\tconst connectionTokenFile = args['connection-token-file'];\n\n\tif (withoutConnectionToken) {\n\t\tif (typeof connectionToken !== 'undefined' || typeof connectionTokenFile !== 'undefined') {\n\t\t\treturn new ServerConnectionTokenParseError(`Please do not use the argument '--connection-token' or '--connection-token-file' at the same time as '--without-connection-token'.`);\n\t\t}\n\t\treturn new NoneServerConnectionToken();\n\t}\n\n\tif (typeof connectionTokenFile !== 'undefined') {\n\t\tif (typeof connectionToken !== 'undefined') {\n\t\t\treturn new ServerConnectionTokenParseError(`Please do not use the argument '--connection-token' at the same time as '--connection-token-file'.`);\n\t\t}\n\n\t\tlet rawConnectionToken: string;\n\t\ttry {\n\t\t\trawConnectionToken = fs.readFileSync(connectionTokenFile).toString().replace(/\\r?\\n$/, '');\n\t\t} catch (e) {\n\t\t\treturn new ServerConnectionTokenParseError(`Unable to read the connection token file at '${connectionTokenFile}'.`);\n\t\t}\n\n\t\tif (!connectionTokenRegex.test(rawConnectionToken)) {\n\t\t\treturn new ServerConnectionTokenParseError(`The connection token defined in '${connectionTokenFile} does not adhere to the characters 0-9, a-z, A-Z, _, or -.`);\n\t\t}\n\n\t\treturn new MandatoryServerConnectionToken(rawConnectionToken);\n\t}\n\n\tif (typeof connectionToken !== 'undefined') {\n\t\tif (!connectionTokenRegex.test(connectionToken)) {\n\t\t\treturn new ServerConnectionTokenParseError(`The connection token '${connectionToken} does not adhere to the characters 0-9, a-z, A-Z or -.`);\n\t\t}\n\n\t\treturn new MandatoryServerConnectionToken(connectionToken);\n\t}\n\n\treturn new MandatoryServerConnectionToken(await defaultValue());\n}\n\nexport async function determineServerConnectionToken(args: ServerParsedArgs): Promise<ServerConnectionToken | ServerConnectionTokenParseError> {\n\tconst readOrGenerateConnectionToken = async () => {\n\t\tif (!args['user-data-dir']) {\n\t\t\t// No place to store it!\n\t\t\treturn generateUuid();\n\t\t}\n\t\tconst storageLocation = path.join(args['user-data-dir'], 'token');\n\n\t\t// First try to find a connection token\n\t\ttry {\n\t\t\tconst fileContents = await fs.promises.readFile(storageLocation);\n\t\t\tconst connectionToken = fileContents.toString().replace(/\\r?\\n$/, '');\n\t\t\tif (connectionTokenRegex.test(connectionToken)) {\n\t\t\t\treturn connectionToken;\n\t\t\t}\n\t\t} catch (err) { }\n\n\t\t// No connection token found, generate one\n\t\tconst connectionToken = generateUuid();\n\n\t\ttry {\n\t\t\t// Try to store it\n\t\t\tawait Promises.writeFile(storageLocation, connectionToken, { mode: 0o600 });\n\t\t} catch (err) { }\n\n\t\treturn connectionToken;\n\t};\n\treturn parseServerConnectionToken(args, readOrGenerateConnectionToken);\n}\n\nexport function requestHasValidConnectionToken(connectionToken: ServerConnectionToken, req: http.IncomingMessage, parsedUrl: url.UrlWithParsedQuery) {\n\t// First check if there is a valid query parameter\n\tif (connectionToken.validate(parsedUrl.query[connectionTokenQueryName])) {\n\t\treturn true;\n\t}\n\n\t// Otherwise, check if there is a valid cookie\n\tconst cookies = cookie.parse(req.headers.cookie || '');\n\treturn connectionToken.validate(cookies[connectionTokenCookieName]);\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IA4BE;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;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","ignoreList":[]}