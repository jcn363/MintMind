{"version":3,"names":["cov_1fv31r4hq4","actualCoverage","VSBuffer","encodeBase64","Emitter","PauseableEmitter","Disposable","DisposableStore","SocketDiagnostics","s","makeRawSocketHeaders","path","query","deubgLabel","f","buffer","Uint8Array","i","Math","round","random","nonce","wrap","headers","join","socketRawEndHeaderSequence","fromString","connectManagedSocket","socket","debugLabel","half","write","d","Promise","resolve","reject","dataSoFar","add","onData","d_1","b","concat","byteLength","index","indexOf","pauseData","rest","slice","fire","onClose","err","Error","onEnd","e","dispose","ManagedSocket","pausableDataEmitter","_register","args","isPaused","queueMicrotask","resume","event","didDisposeEmitter","onDidDispose","ended","constructor","data","pause","drain","end","closeRemote","traceSocketEvent","type"],"sources":["/home/user/Desktop/MintMind/src/vs/platform/remote/common/managedSocket.ts"],"sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer, encodeBase64 } from '../../../base/common/buffer.js';\nimport { Emitter, Event, PauseableEmitter } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore } from '../../../base/common/lifecycle.js';\nimport { ISocket, SocketCloseEvent, SocketDiagnostics, SocketDiagnosticsEventType } from '../../../base/parts/ipc/common/ipc.net.js';\n\nexport const makeRawSocketHeaders = (path: string, query: string, deubgLabel: string) => {\n\t// https://tools.ietf.org/html/rfc6455#section-4\n\tconst buffer = new Uint8Array(16);\n\tfor (let i = 0; i < 16; i++) {\n\t\tbuffer[i] = Math.round(Math.random() * 256);\n\t}\n\tconst nonce = encodeBase64(VSBuffer.wrap(buffer));\n\n\tconst headers = [\n\t\t`GET ws://localhost${path}?${query}&skipWebSocketFrames=true HTTP/1.1`,\n\t\t`Connection: Upgrade`,\n\t\t`Upgrade: websocket`,\n\t\t`Sec-WebSocket-Key: ${nonce}`\n\t];\n\n\treturn headers.join('\\r\\n') + '\\r\\n\\r\\n';\n};\n\nexport const socketRawEndHeaderSequence = VSBuffer.fromString('\\r\\n\\r\\n');\n\nexport interface RemoteSocketHalf {\n\tonData: Emitter<VSBuffer>;\n\tonClose: Emitter<SocketCloseEvent>;\n\tonEnd: Emitter<void>;\n}\n\n/** Should be called immediately after making a ManagedSocket to make it ready for data flow. */\nexport async function connectManagedSocket<T extends ManagedSocket>(\n\tsocket: T,\n\tpath: string, query: string, debugLabel: string,\n\thalf: RemoteSocketHalf\n): Promise<T> {\n\tsocket.write(VSBuffer.fromString(makeRawSocketHeaders(path, query, debugLabel)));\n\n\tconst d = new DisposableStore();\n\ttry {\n\t\treturn await new Promise<T>((resolve, reject) => {\n\t\t\tlet dataSoFar: VSBuffer | undefined;\n\t\t\td.add(socket.onData(d_1 => {\n\t\t\t\tif (!dataSoFar) {\n\t\t\t\t\tdataSoFar = d_1;\n\t\t\t\t} else {\n\t\t\t\t\tdataSoFar = VSBuffer.concat([dataSoFar, d_1], dataSoFar.byteLength + d_1.byteLength);\n\t\t\t\t}\n\n\t\t\t\tconst index = dataSoFar.indexOf(socketRawEndHeaderSequence);\n\t\t\t\tif (index === -1) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tresolve(socket);\n\t\t\t\t// pause data events until the socket consumer is hooked up. We may\n\t\t\t\t// immediately emit remaining data, but if not there may still be\n\t\t\t\t// microtasks queued which would fire data into the abyss.\n\t\t\t\tsocket.pauseData();\n\n\t\t\t\tconst rest = dataSoFar.slice(index + socketRawEndHeaderSequence.byteLength);\n\t\t\t\tif (rest.byteLength) {\n\t\t\t\t\thalf.onData.fire(rest);\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\td.add(socket.onClose(err => reject(err ?? new Error('socket closed'))));\n\t\t\td.add(socket.onEnd(() => reject(new Error('socket ended'))));\n\t\t});\n\t} catch (e) {\n\t\tsocket.dispose();\n\t\tthrow e;\n\t} finally {\n\t\td.dispose();\n\t}\n}\n\nexport abstract class ManagedSocket extends Disposable implements ISocket {\n\tprivate readonly pausableDataEmitter = this._register(new PauseableEmitter<VSBuffer>());\n\n\tpublic onData: Event<VSBuffer> = (...args) => {\n\t\tif (this.pausableDataEmitter.isPaused) {\n\t\t\tqueueMicrotask(() => this.pausableDataEmitter.resume());\n\t\t}\n\t\treturn this.pausableDataEmitter.event(...args);\n\t};\n\tpublic onClose: Event<SocketCloseEvent>;\n\tpublic onEnd: Event<void>;\n\n\tprivate readonly didDisposeEmitter = this._register(new Emitter<void>());\n\tpublic onDidDispose = this.didDisposeEmitter.event;\n\n\tprivate ended = false;\n\n\tprotected constructor(\n\t\tprivate readonly debugLabel: string,\n\t\thalf: RemoteSocketHalf,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(half.onData);\n\t\tthis._register(half.onData.event(data => this.pausableDataEmitter.fire(data)));\n\n\t\tthis.onClose = this._register(half.onClose).event;\n\t\tthis.onEnd = this._register(half.onEnd).event;\n\t}\n\n\t/** Pauses data events until a new listener comes in onData() */\n\tpublic pauseData() {\n\t\tthis.pausableDataEmitter.pause();\n\t}\n\n\t/** Flushes data to the socket. */\n\tpublic drain(): Promise<void> {\n\t\treturn Promise.resolve();\n\t}\n\n\t/** Ends the remote socket. */\n\tpublic end(): void {\n\t\tthis.ended = true;\n\t\tthis.closeRemote();\n\t}\n\n\tpublic abstract write(buffer: VSBuffer): void;\n\tprotected abstract closeRemote(): void;\n\n\ttraceSocketEvent(type: SocketDiagnosticsEventType, data?: any): void {\n\t\tSocketDiagnostics.traceSocketEvent(this, this.debugLabel, type, data);\n\t}\n\n\toverride dispose(): void {\n\t\tif (!this.ended) {\n\t\t\tthis.closeRemote();\n\t\t}\n\n\t\tthis.didDisposeEmitter.fire();\n\t\tsuper.dispose();\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}